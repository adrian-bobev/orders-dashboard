services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
        - NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY}
        - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL}
    extra_hosts:
      - "localhost:host-gateway"
      - "prikazko.local:host-gateway"
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - PDF_SERVICE_URL=http://pdf-create:4001
      - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - WOOCOMMERCE_STORE_URL=${WOOCOMMERCE_STORE_URL}
      - WOOCOMMERCE_CONSUMER_KEY=${WOOCOMMERCE_CONSUMER_KEY}
      - WOOCOMMERCE_CONSUMER_SECRET=${WOOCOMMERCE_CONSUMER_SECRET}
      - WOOCOMMERCE_WEBHOOK_SECRET=${WOOCOMMERCE_WEBHOOK_SECRET}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
      - EMAIL_FROM=${EMAIL_FROM}
      - RESEND_API_KEY=${RESEND_API_KEY}
      - PDF_SERVICE_ACCESS_TOKEN=${PDF_SERVICE_ACCESS_TOKEN}
      - R2_ENDPOINT=${R2_ENDPOINT}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
      - R2_BUCKET=${R2_BUCKET}
      - R2_GENERATIONS_BUCKET=${R2_GENERATIONS_BUCKET}
      - R2_PREVIEWS_BUCKET=${R2_PREVIEWS_BUCKET}
      - R2_PRINTS_BUCKET=${R2_PRINTS_BUCKET}
      - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - FAL_KEY=${FAL_KEY}
      - REPLICATE_API_TOKEN=${REPLICATE_API_TOKEN}
      - APPROVAL_SECRET_KEY=${APPROVAL_SECRET_KEY}
      - WORKER_URL=http://worker:4000
      - WORKER_WAKE_TOKEN=${WORKER_WAKE_TOKEN}
    depends_on:
      pdf-create:
        condition: service_healthy
    restart: always
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  pdf-create:
    build:
      context: ./packages/pdf-create
      dockerfile: Dockerfile
    ports:
      - "4001:4001"
    environment:
      - PORT=4001
      - ACCESS_TOKEN=${PDF_SERVICE_ACCESS_TOKEN}
      - R2_ENDPOINT=${R2_ENDPOINT}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
      - R2_BUCKET=${R2_BUCKET}
      - R2_PREVIEWS_BUCKET=${R2_PREVIEWS_BUCKET}
    volumes:
      - pdf-uploads:/app/uploads
    restart: always
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  worker:
    build:
      context: .
      dockerfile: Dockerfile.worker
    extra_hosts:
      - "localhost:host-gateway"
      - "prikazko.local:host-gateway"
    ports:
      - "4000:4000"
    environment:
      - NODE_ENV=production
      - PDF_SERVICE_URL=http://pdf-create:4001
      - WORKER_ID=worker-1
      - WORKER_POLL_INTERVAL_MS=3600000
      - WORKER_HTTP_PORT=4000
      - WORKER_WAKE_TOKEN=${WORKER_WAKE_TOKEN}
      - SUPABASE_URL=http://host.docker.internal:54321
      - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
      - EMAIL_FROM=${EMAIL_FROM}
      - RESEND_API_KEY=${RESEND_API_KEY}
      - PDF_SERVICE_ACCESS_TOKEN=${PDF_SERVICE_ACCESS_TOKEN}
      - R2_ENDPOINT=${R2_ENDPOINT}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
      - R2_BUCKET=${R2_BUCKET}
      - R2_GENERATIONS_BUCKET=${R2_GENERATIONS_BUCKET}
      - R2_PREVIEWS_BUCKET=${R2_PREVIEWS_BUCKET}
      - R2_PRINTS_BUCKET=${R2_PRINTS_BUCKET}
      - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL}
      - WOOCOMMERCE_STORE_URL=${WOOCOMMERCE_STORE_URL}
      - APPROVAL_SECRET_KEY=${APPROVAL_SECRET_KEY}
    volumes:
      - webhook-logs:/app/webhook-logs
    depends_on:
      pdf-create:
        condition: service_healthy
    restart: always
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  pdf-uploads:
  webhook-logs:
